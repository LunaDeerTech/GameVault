# 数据库迁移指南 (Alembic)

本文档详细介绍如何在 GameVault 项目中使用 Alembic 进行数据库表结构迁移。

## 目录
- [什么是 Alembic](#什么是-alembic)
- [项目配置](#项目配置)
- [基础使用流程](#基础使用流程)
- [常用命令](#常用命令)
- [常见场景示例](#常见场景示例)
- [注意事项](#注意事项)
- [故障排除](#故障排除)

---

## 什么是 Alembic

Alembic 是 SQLAlchemy 的数据库迁移工具，它可以：
- ✅ 自动生成数据库迁移脚本
- ✅ 版本化管理数据库结构变更
- ✅ 支持升级和回滚操作
- ✅ 保留现有数据
- ✅ 团队协作时同步数据库结构

---

## 项目配置

### 目录结构
```
server/
├── alembic/                # Alembic 配置目录
│   ├── versions/          # 迁移脚本存放处（自动生成）
│   ├── env.py            # 环境配置（已配置好）
│   └── script.py.mako    # 迁移脚本模板
├── alembic.ini            # Alembic 主配置文件
├── app/
│   ├── models/           # 数据库模型定义
│   └── core/
│       └── database.py   # 数据库连接配置
└── storage/
    └── gamevault.db      # SQLite 数据库文件
```

### 已完成的配置

1. **alembic.ini** - 数据库 URL 已设置为 `sqlite:///./storage/gamevault.db`
2. **alembic/env.py** - 已配置自动导入所有模型和应用配置
3. **app/core/database.py** - 已实现 `init_db()` 和 `get_db()` 函数

---

## 基础使用流程

### 第一次使用（初始化数据库）

如果这是全新的项目，需要创建初始迁移：

```bash
# 1. 激活 conda 环境
conda activate game-vault

# 2. 进入 server 目录
cd server

# 3. 创建初始迁移脚本
alembic revision --autogenerate -m "Initial migration"

# 4. 查看生成的迁移脚本（可选，在 alembic/versions/ 目录下）
# 检查脚本内容是否正确

# 5. 应用迁移（创建所有表）
alembic upgrade head
```

### 修改表结构的完整流程

#### 步骤 1：修改 Model 文件

例如，为 `Game` 模型添加新字段：

```python
# server/app/models/game.py

class Game(Base):
    """Game model"""
    __tablename__ = "games"
    
    # ...现有字段...
    
    # 新增字段
    last_played = Column(DateTime(timezone=True), nullable=True)
    install_size = Column(BigInteger, nullable=True)
    genre = Column(String(100), nullable=True)
    tags = Column(Text, nullable=True)  # JSON-encoded list
```

#### 步骤 2：生成迁移脚本

```bash
# 自动生成迁移脚本（Alembic 会自动检测变更）
alembic revision --autogenerate -m "Add last_played, install_size, genre, and tags to games"
```

这会在 `alembic/versions/` 目录下生成一个新的迁移文件，例如：
```
alembic/versions/abc123def456_add_last_played_install_size_genre_and_tags_to_games.py
```

#### 步骤 3：检查迁移脚本（推荐）

打开生成的迁移文件，检查 `upgrade()` 和 `downgrade()` 函数：

```python
def upgrade():
    # ### commands auto generated by Alembic ###
    op.add_column('games', sa.Column('last_played', sa.DateTime(timezone=True), nullable=True))
    op.add_column('games', sa.Column('install_size', sa.BigInteger(), nullable=True))
    op.add_column('games', sa.Column('genre', sa.String(length=100), nullable=True))
    op.add_column('games', sa.Column('tags', sa.Text(), nullable=True))
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic ###
    op.drop_column('games', 'tags')
    op.drop_column('games', 'genre')
    op.drop_column('games', 'install_size')
    op.drop_column('games', 'last_played')
    # ### end Alembic commands ###
```

#### 步骤 4：应用迁移

```bash
# 升级到最新版本
alembic upgrade head
```

#### 步骤 5：验证（可选）

```bash
# 查看当前数据库版本
alembic current

# 查看迁移历史
alembic history
```

---

## 常用命令

### 查看状态

```bash
# 查看当前数据库版本
alembic current

# 查看迁移历史
alembic history

# 查看详细历史（显示每个版本的信息）
alembic history --verbose
```

### 创建迁移

```bash
# 自动生成迁移脚本（推荐）
alembic revision --autogenerate -m "描述你的修改"

# 手动创建空白迁移脚本
alembic revision -m "描述你的修改"
```

### 应用迁移

```bash
# 升级到最新版本
alembic upgrade head

# 升级到指定版本
alembic upgrade abc123

# 升级一个版本
alembic upgrade +1

# 升级两个版本
alembic upgrade +2
```

### 回滚迁移

```bash
# 回滚到上一个版本
alembic downgrade -1

# 回滚到指定版本
alembic downgrade abc123

# 回滚所有迁移（清空数据库）
alembic downgrade base
```

### 查看 SQL（不执行）

```bash
# 查看升级到 head 会执行的 SQL
alembic upgrade head --sql

# 查看回滚一个版本会执行的 SQL
alembic downgrade -1 --sql
```

---

## 常见场景示例

### 场景 1：添加新字段

**修改 Model：**
```python
class User(Base):
    __tablename__ = "users"
    # ...现有字段...
    phone = Column(String(20), nullable=True)  # 新增
```

**执行迁移：**
```bash
alembic revision --autogenerate -m "Add phone to users"
alembic upgrade head
```

---

### 场景 2：修改字段类型

**修改 Model：**
```python
class Game(Base):
    __tablename__ = "games"
    # 将 steam_id 从 String 改为 Integer
    steam_id = Column(Integer, nullable=True, index=True)  # 修改类型
```

**生成迁移：**
```bash
alembic revision --autogenerate -m "Change steam_id type to Integer"
```

**手动编辑生成的迁移文件（重要！）：**
```python
def upgrade():
    # 对于 SQLite，需要重建表（SQLite 不支持直接修改列类型）
    op.execute('ALTER TABLE games RENAME TO games_old')
    
    op.create_table('games',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('steam_id', sa.Integer(), nullable=True),
        # ...其他列...
    )
    
    # 复制数据（将 steam_id 转换为整数）
    op.execute('''
        INSERT INTO games (id, steam_id, ...)
        SELECT id, CAST(steam_id AS INTEGER), ...
        FROM games_old
    ''')
    
    op.drop_table('games_old')
```

**应用迁移：**
```bash
alembic upgrade head
```

---

### 场景 3：删除字段

**修改 Model：**
```python
class Game(Base):
    __tablename__ = "games"
    # 删除 intro_images 字段（从代码中移除该行）
```

**执行迁移：**
```bash
alembic revision --autogenerate -m "Remove intro_images from games"
alembic upgrade head
```

---

### 场景 4：添加索引

**修改 Model：**
```python
class Game(Base):
    __tablename__ = "games"
    name = Column(String(255), nullable=False, index=True)  # 添加 index=True
```

**执行迁移：**
```bash
alembic revision --autogenerate -m "Add index to game name"
alembic upgrade head
```

---

### 场景 5：创建新表

**创建新 Model：**
```python
# server/app/models/review.py
from sqlalchemy import Column, ForeignKey, Integer, String, Text, DateTime
from app.core.database import Base

class Review(Base):
    """Game review model"""
    __tablename__ = "reviews"
    
    id = Column(Integer, primary_key=True)
    game_id = Column(Integer, ForeignKey("games.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    rating = Column(Integer, nullable=False)
    comment = Column(Text, nullable=True)
```

**在 `__init__.py` 中导入：**
```python
# server/app/models/__init__.py
from .game import Game, ContentRating
from .user import User
from .save import Save
from .playtime import Playtime
from .review import Review  # 新增
```

**执行迁移：**
```bash
alembic revision --autogenerate -m "Create reviews table"
alembic upgrade head
```

---

### 场景 6：添加外键约束

**修改 Model：**
```python
class Game(Base):
    __tablename__ = "games"
    # ...
    content_rating_age_limit = Column(
        Integer, 
        ForeignKey("content_ratings.age_limit"),  # 添加外键
        nullable=True
    )
```

**执行迁移：**
```bash
alembic revision --autogenerate -m "Add foreign key to content_rating"
alembic upgrade head
```

---

## 注意事项

### ⚠️ 重要提示

1. **永远先备份数据库**
   ```bash
   # 在执行迁移前备份
   cp storage/gamevault.db storage/gamevault.db.backup
   ```

2. **检查自动生成的迁移脚本**
   - Alembic 的自动生成可能不完美
   - 复杂的修改（如修改字段类型）可能需要手动调整
   - SQLite 的限制较多，某些操作需要重建表

3. **团队协作**
   - 将 `alembic/versions/` 目录提交到 Git
   - 不要提交 `storage/gamevault.db` 数据库文件
   - 拉取代码后运行 `alembic upgrade head` 同步数据库

4. **生产环境**
   - 在测试环境先验证迁移
   - 使用 `--sql` 参数预览 SQL
   - 确保有数据库备份

5. **命名规范**
   - 迁移消息使用英文，简洁明了
   - 格式：`动词 + 对象 + 补充说明`
   - 例如：`Add email field to users`、`Create posts table`

---

## 故障排除

### 问题 1：`alembic` 命令未找到

**解决方法：**
```bash
# 确保已激活 conda 环境
conda activate game-vault

# 安装 alembic
pip install alembic==1.12.1

# 或使用完整路径
C:\Users\ZhangYuheng\miniconda3\Scripts\conda.exe run -n game-vault alembic upgrade head
```

---

### 问题 2：自动生成没有检测到修改

**原因：** Model 没有被正确导入

**解决方法：**
1. 确保新 Model 在 `app/models/__init__.py` 中导入
2. 确保 `alembic/env.py` 中导入了所有 models
3. 检查是否有语法错误

---

### 问题 3：迁移冲突

**场景：** 多人开发时出现迁移版本冲突

**解决方法：**
```bash
# 1. 拉取最新代码
git pull

# 2. 查看迁移分支
alembic branches

# 3. 合并迁移分支
alembic merge -m "Merge migration branches" head1 head2

# 4. 应用合并后的迁移
alembic upgrade head
```

---

### 问题 4：SQLite 不支持某些操作

**SQLite 限制：**
- 不能直接修改列类型
- 不能删除列（需要重建表）
- 外键支持有限

**解决方法：** 使用表重建策略（参见场景 2）

---

### 问题 5：回滚后数据丢失

**原因：** `downgrade()` 函数执行了 `DROP COLUMN` 或 `DROP TABLE`

**预防措施：**
- 在执行迁移前备份数据库
- 仔细检查 `downgrade()` 函数
- 生产环境谨慎使用回滚

---

## 开发工作流建议

### 开发新功能时

1. **创建功能分支**
   ```bash
   git checkout -b feature/add-reviews
   ```

2. **修改 Model**
   - 编辑 `app/models/` 中的文件

3. **生成迁移**
   ```bash
   alembic revision --autogenerate -m "Add reviews feature"
   ```

4. **测试迁移**
   ```bash
   alembic upgrade head
   # 测试功能
   alembic downgrade -1  # 测试回滚
   alembic upgrade head  # 重新升级
   ```

5. **提交代码**
   ```bash
   git add app/models/ alembic/versions/
   git commit -m "feat: Add reviews feature"
   ```

---

### 合并代码时

1. **拉取最新代码**
   ```bash
   git pull origin main
   ```

2. **应用数据库迁移**
   ```bash
   alembic upgrade head
   ```

3. **检查数据库状态**
   ```bash
   alembic current
   ```

---

## 快速参考

| 操作 | 命令 |
|------|------|
| 创建迁移 | `alembic revision --autogenerate -m "message"` |
| 应用迁移 | `alembic upgrade head` |
| 回滚一步 | `alembic downgrade -1` |
| 查看当前版本 | `alembic current` |
| 查看历史 | `alembic history` |
| 查看 SQL | `alembic upgrade head --sql` |
| 回滚到初始 | `alembic downgrade base` |

---

## 相关文件

- **配置文件：** `server/alembic.ini`
- **环境配置：** `server/alembic/env.py`
- **迁移脚本：** `server/alembic/versions/`
- **数据库模型：** `server/app/models/`
- **数据库配置：** `server/app/core/database.py`
- **数据库文件：** `server/storage/gamevault.db`

---

## 其他资源

- [Alembic 官方文档](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 官方文档](https://docs.sqlalchemy.org/)
- [项目根目录 README.md](../README.md)

---

**最后更新：** 2025-11-28
